define(["Ti/_/browser","Ti/_/declare","Ti/UI/View","Ti/_/lang","Ti/_/dom","Ti/_/style","Ti/UI","Ti/_/event"],function(t,e,i,n,r,o,a){var s=(o.set,r.unitize),u=r.calculateDistance,l=require.on,c=100,h=100;return e("Ti._.UI.KineticScrollView",i,{_initKineticScrollView:function(t,e,i,n){function r(){m=Date.now(),T=m-p,p=m,y++?(E=(E*(y-1)+y*(d-v)/T)/2/y,I=(I*(y-1)+y*(_-b)/T)/2/y):(E=(d-c)/T,I=(_-h)/T)}function o(){f=w._minTranslationX=Math.min(0,w._measuredWidth-w._borderLeftWidth-w._borderRightWidth-w._contentContainer._measuredWidth),g=w._minTranslationY=Math.min(0,w._measuredHeight-w._borderTopWidth-w._borderBottomWidth-w._contentContainer._measuredHeight)}var s,c,h,d,_,f,g,p,m,T,v,b,y,E,I,x,w=this;w._currentTranslationX=0,w._currentTranslationY=0,w._horizontalElastic="horizontal"===e||"both"===e,w._verticalElastic="vertical"===e||"both"===e,w._kineticTransform=a.create2DMatrix(),("horizontal"===i||"both"===i)&&w._createHorizontalScrollBar(),("vertical"===i||"both"===i)&&w._createVerticalScrollBar(),w._add(w._contentContainer=t),s=t.domNode,l(w._contentContainer,"postlayout",function(){o(),w._setTranslation(w._currentTranslationX,w._currentTranslationY)}),l(w,"draggingstart",function(e){if(w.scrollingEnabled){w._cancelAnimations(),E=void 0,I=void 0,c=w._currentTranslationX,h=w._currentTranslationY,y=0,p=(new Date).getTime(),o();var i=w._measuredWidth,n=w._measuredHeight,r=t._measuredWidth,a=t._measuredHeight;w._startScrollBars({x:-w._currentTranslationX/(r-i),y:-w._currentTranslationY/(a-n)},{x:i/r,y:n/a}),w._handleDragStart&&w._handleDragStart(e)}}),l(w,"dragging",function(t){w.scrollingEnabled&&(d=c+t.distanceX,_=h+t.distanceY,r(),w._setTranslation(v=d,b=_),w._handleDrag&&w._handleDrag(t))}),l(w,"draggingcancel",function(t){w.scrollingEnabled&&(w._animateToPosition(c,h,400+.3*u(c,h,w._currentTranslationX,w._currentTranslationY),a.ANIMATION_CURVE_EASE_IN_OUT,function(){w._handleDragCancel&&w._handleDragCancel(t)}),w._endScrollBars(),w._handleDragCancel&&w._handleDragCancel(t))}),l(w,"draggingend",function(t){if(w.scrollingEnabled){d=c+t.distanceX,_=h+t.distanceY,r();var e,i=w._currentTranslationX,n=w._currentTranslationY;i>0?(i=0,e=1):f>i&&(i=f,e=1),n>0?(n=0,e=1):g>n&&(n=g,e=1),e?w._animateToPosition(i,n,200,a.ANIMATION_CURVE_EASE_OUT,function(){w._handleDragEnd&&w._handleDragEnd(t),w._endScrollBars()}):w._handleDragEnd&&w._handleDragEnd(t,E,I)}}),n&&(this._disconnectMouseWheelEvent=l(w.domNode,"mousewheel",function(e){if(w.scrollingEnabled){w._cancelAnimations();var i=t._measuredWidth-w._measuredWidth,n=t._measuredHeight-w._measuredHeight,r=-w._currentTranslationX,a=-w._currentTranslationY;o(),w._startScrollBars({x:r/i,y:a/n},{x:w._measuredWidth/t._measuredWidth,y:w._measuredHeight/t._measuredHeight}),w._setTranslation(Math.min(0,Math.max(w._minTranslationX,-r+e.wheelDeltaX)),Math.min(0,Math.max(w._minTranslationY,-a+e.wheelDeltaY))),clearTimeout(x),x=setTimeout(function(){w._endScrollBars()},500),w._handleMouseWheel&&w._handleMouseWheel()}}))},destroy:function(){this._disconnectMouseWheelEvent&&this._disconnectMouseWheelEvent(),i.prototype.destroy.apply(this,arguments)},_animateToPosition:function(t,e,i,n,r){var o,a=this,s=a._contentContainer,l=(s.domNode,a._horizontalScrollBar),c=a._verticalScrollBar;1>u(a._currentTranslationX,a._currentTranslationY,t,e)?(a._setTranslation(t,e),r()):(o=a._setTranslation(t,e,1),a._contentAnimation=s.animate({transform:a._kineticTransform.translate(o.translationX,o.translationY),duration:Math.round(i),curve:n},r),a._horizontalScrollBarAnimation=l&&l.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-o.translationX/(s._measuredWidth-a._measuredWidth)))*(this._measuredWidth-this._scrollBarWidth),0),duration:i,curve:n}),a._verticalScrollBarAnimation=c&&c.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-o.translationY/(s._measuredHeight-a._measuredHeight)))*(this._measuredHeight-this._scrollBarHeight)),duration:i,curve:n}))},_setTranslation:function(t,e,i){function n(t){return c*(-1/(t/h+1)+1)}var r=this._contentContainer,o=this._minTranslationX,a=this._minTranslationY,s=this._horizontalElastic&&!this.disableBounce&&this._measuredWidth<r._measuredWidth,u=this._verticalElastic&&!this.disableBounce&&this._measuredHeight<r._measuredHeight,l=this._measuredWidth,d=this._measuredHeight,_=r._measuredWidth,f=r._measuredHeight;if(t>0?t=s?n(t):0:o>t&&(t=s?o-n(o-t):o),e>0?e=u?n(e):0:a>e&&(e=u?a-n(a-e):a),i||this._contentContainer.animate({transform:this._kineticTransform.translate(this._currentTranslationX=t,this._currentTranslationY=e)}),this._isScrollBarActive){var g=this._horizontalScrollBar,p=this._verticalScrollBar;g&&g.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-t/(_-l)))*(this._measuredWidth-this._scrollBarWidth),0)}),p&&p.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-e/(f-d)))*(this._measuredHeight-this._scrollBarHeight))})}return{translationX:t,translationY:e}},_cancelAnimations:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._contentAnimation&&this._contentAnimation.cancel()},_createHorizontalScrollBar:function(){this._horizontalScrollBar||this._add(this._horizontalScrollBar=a.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:0,height:6,left:0,bottom:0,opacity:0}))},_createVerticalScrollBar:function(){this._verticalScrollBar||this._add(this._verticalScrollBar=a.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:6,height:0,right:0,top:0,opacity:0}))},_destroyHorizontalScrollBar:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._remove(this._horizontalScrollBar)},_destroyVerticalScrollBar:function(){this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._remove(this._verticalScrollBar)},_startScrollBars:function(t,e){if(this._horizontalScrollBar&&1>e.x&&e.x>0){var i=this._measuredWidth,n=this._scrollBarWidth=Math.round(Math.max(10,i*e.x)),r=this._horizontalScrollBar;r.opacity=.5,r.domNode.style.width=s(n),r.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,t.x))*(i-n),0)}),this._isScrollBarActive=1}if(this._verticalScrollBar&&1>e.y&&e.y>0){var o=this._measuredHeight,a=this._scrollBarHeight=Math.round(Math.max(10,o*e.y)),u=this._verticalScrollBar;u.opacity=.5,u.domNode.style.height=s(a),u.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,t.y))*(o-a))}),this._isScrollBarActive=1}},_endScrollBars:function(){function t(t){t&&t.animate({opacity:0,duration:500},function(){e._isScrollBarActive=!1})}if(this._isScrollBarActive){var e=this,i=e._horizontalScrollBar,n=e._verticalScrollBar;t(i),t(n)}},properties:{scrollingEnabled:!0}})});