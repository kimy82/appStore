define(["Ti/_/Layouts/Base","Ti/_/declare","Ti/UI","Ti/_/lang"],function(t,e,i,n){var r=n.isDef,o="px",a=Math.round;return e("Ti._.Layouts.Composite",t,{_doLayout:function(t,e,n,r,s){var u,c,l,h,d,_,f,p,g,T,m,v,E,b,I,y,w,S,A={width:0,height:0},N=t._children,C=0,x=[],L=[],O=N.length,R=this._measureNode;for(C=0;O>C;C++)u=t._children[C],u._alive&&u.domNode?(u._markedForLayout&&((u._preLayout&&u._preLayout(e,n,r,s)||u._needsMeasuring)&&R(u,u,u._layoutCoefficients,this),c=u._layoutCoefficients,l=c.width,g=c.minWidth,h=c.height,T=c.minHeight,d=c.sandboxWidth,_=c.sandboxHeight,p=c.left,f=c.top,v=l.x1*e+l.x2,void 0!==g.x1&&(v=Math.max(v,g.x1*e+g.x2)),E=h.x1*n+h.x2,void 0!==T.x1&&(E=Math.max(E,T.x1*n+T.x2)),m=u._getContentSize?u._getContentSize(v,E):u._layout._doLayout(u,isNaN(v)?e:v-u._borderLeftWidth-u._borderRightWidth,isNaN(E)?n:E-u._borderTopWidth-u._borderBottomWidth,isNaN(v),isNaN(E)),isNaN(v)&&(v=m.width+u._borderLeftWidth+u._borderRightWidth,void 0!==g.x1&&(v=Math.max(v,g.x1*e+g.x2))),isNaN(E)&&(E=m.height+u._borderTopWidth+u._borderBottomWidth,void 0!==T.x1&&(E=Math.max(E,T.x1*n+T.x2))),r&&0!==p.x1?x.push(u):y=p.x1*e+p.x2*v+p.x3,s&&0!==f.x1?L.push(u):w=f.x1*n+f.x2*E+f.x3,u._measuredSandboxWidth=I=d.x1*n+d.x2+v+(isNaN(y)?0:y),u._measuredSandboxHeight=b=_.x1*n+_.x2+E+(isNaN(w)?0:w),u._measuredWidth=v,u._measuredHeight=E,u._measuredLeft=y,u._measuredTop=w),u._measuredSandboxWidth>A.width&&(A.width=u._measuredSandboxWidth),u._measuredSandboxHeight>A.height&&(A.height=u._measuredSandboxHeight)):this.handleInvalidState(u,t);for(O=x.length,C=0;O>C;C++)u=x[C],p=u._layoutCoefficients.left,d=u._layoutCoefficients.sandboxWidth,u._measuredLeft=y=p.x1*A.width+p.x2*v+p.x3,u._measuredSandboxWidth=I=d.x1*n+d.x2+u._measuredWidth+y,I=u._measuredSandboxWidth,I>A.width&&(A.width=I);for(O=L.length,C=0;O>C;C++)u=L[C],f=u._layoutCoefficients.top,_=u._layoutCoefficients.sandboxHeight,u._measuredTop=w=f.x1*A.height+f.x2*E+f.x3,u._measuredSandboxHeight=b=_.x1*n+_.x2+u._measuredHeight+w,b=u._measuredSandboxHeight,b>A.height&&(A.height=b);for(O=N.length,C=0;O>C;C++)u=N[C],u._markedForLayout&&(i._elementLayoutCount++,S=u.domNode.style,S.zIndex=u.zIndex,S.left=a(u._measuredLeft)+o,S.top=a(u._measuredTop)+o,S.width=a(u._measuredWidth-u._borderLeftWidth-u._borderRightWidth)+o,S.height=a(u._measuredHeight-u._borderTopWidth-u._borderBottomWidth)+o,u._markedForLayout=!1,u.fireEvent("postlayout"));return this._computedSize=A},_getWidth:function(t,e){return!r(e)&&2>r(t.left)+r(t.center&&t.center.x)+r(t.right)&&(e=t._defaultWidth),e===i.INHERIT?t._parent._parent?t._parent._parent._layout._getWidth(t._parent,t._parent.width)===i.SIZE?i.SIZE:i.FILL:i.FILL:e},_getHeight:function(t,e){return!r(e)&&2>r(t.top)+r(t.center&&t.center.y)+r(t.bottom)&&(e=t._defaultHeight),e===i.INHERIT?t._parent._parent?t._parent._parent._layout._getHeight(t._parent,t._parent.height)===i.SIZE?i.SIZE:i.FILL:i.FILL:e},_isDependentOnParent:function(t){var e=t._layoutCoefficients;return!isNaN(e.width.x1)&&0!==e.width.x1||!isNaN(e.height.x1)&&0!==e.height.x1||0!==e.left.x1||0!==e.top.x1},_doAnimationLayout:function(t,e){var i=t._parent._measuredWidth,n=t._parent._measuredHeight,r=e.width.x1*i+e.width.x2,o=e.height.x1*n+e.height.x2;return{width:r,height:o,left:e.left.x1*i+e.left.x2*r+e.left.x3,top:e.top.x1*n+e.top.x2*o+e.top.x3}},_measureNode:function(t,e,n,r){t._needsMeasuring=!1;for(var o,a,s,u,c,l,h,d,_,f,p,g,T,m=r.getValueType,v=r.computeValue,E=r._getWidth(t,e.width),b=m(E),I=v(E,b),y=e._minWidth,w=m(y),S=v(y,w),A=r._getHeight(t,e.height),N=m(A),C=v(A,N),x=e._minHeight,L=m(x),O=v(x,L),R=e.left,D=m(R),P=v(R,D),U=e.center&&e.center.x,k=m(U),M=v(U,k),B=e.right,F=m(B),V=v(B,F),W=e.top,H=m(W),G=v(W,H),Y=e.center&&e.center.y,q=m(Y),j=v(Y,q),z=e.bottom,X=m(z),Z=v(z,X),K=n.sandboxWidth,J=n.sandboxHeight,$=[[b,I,D,P,k,M,F,V],[N,C,H,G,q,j,X,Z]],Q=0;2>Q;Q++)u=$[Q],c=u[0],l=u[1],h=u[2],d=u[3],_=u[4],f=u[5],p=u[6],g=u[7],o=a=0,c===i.SIZE?o=a=0/0:c===i.FILL?(o=1,"%"===h?o-=d:"#"===h?a=-d:"%"===p?o-=g:"#"===p&&(a=-g)):"%"===c?o=l:"#"===c?a=l:"%"===h?"%"===_?o=2*(f-d):"#"===_?(o=-2*d,a=2*f):"%"===p?o=1-d-g:"#"===p&&(o=1-d,a=-g):"#"===h?"%"===_?(o=2*f,a=-2*d):"#"===_?a=2*(f-d):"%"===p?(o=1-g,a=-d):"#"===p&&(o=1,a=-g-d):"%"===_?"%"===p?o=2*(g-f):"#"===p&&(o=-2*f,a=2*g):"#"===_&&("%"===p?(o=2*g,a=-2*f):"#"===p&&(a=2*(g-f))),n[T=0===Q?"width":"height"].x1=o,n[T].x2=a;$={minWidth:[w,S,D,P,k,M,F,V],minHeight:[L,O,H,G,q,j,X,Z]};for(Q in $)u=$[Q],c=u[0],l=u[1],h=u[2],d=u[3],_=u[4],f=u[5],p=u[6],g=u[7],o=a=s=0,c===i.SIZE?o=a=0/0:c===i.FILL?(o=1,"%"===h?o-=d:"#"===h?a=-d:"%"===p?o-=g:"#"===p&&(a=-g)):"%"===c?o=l:"#"===c?a=l:o=a=s=void 0,n[Q].x1=o,n[Q].x2=a,n[Q].x3=s;for($=[[D,P,k,M,F,V],[H,G,q,j,X,Z]],Q=0;2>Q;Q++){if(u=$[Q],h=u[0],d=u[1],_=u[2],f=u[3],p=u[4],g=u[5],o=a=s=0,"%"===h)o=d;else if("#"===h)s=d;else if("%"===_)o=f,a=-.5;else if("#"===_)a=-.5,s=f;else if("%"===p)o=1-g,a=-1;else if("#"===p)o=1,a=-1,s=-g;else switch("left"===Q?r._defaultHorizontalAlignment:r._defaultVerticalAlignment){case"center":o=.5,a=-.5;break;case"end":o=1,a=-1}n[T=0===Q?"left":"top"].x1=o,n[T].x2=a,n[T].x3=s}K.x1="%"===F?V:0,K.x2="#"===F?V:0,J.x1="%"===X?Z:0,J.x2="#"===X?Z:0},_defaultHorizontalAlignment:"center",_defaultVerticalAlignment:"center"})});