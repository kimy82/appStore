define(["./declare","./lang"],function(t,e){var i=require.is,n=t("Ti._.Promise",null,{constructor:function(t){this._canceller=t},resolve:function(t){this._complete(t,0)},reject:function(t){this._complete(t,1)},then:function(t,e){var i={resolved:t,error:e,promise:new n(this.cancel)};return this._nextListener?this._head=this._head.next=i:this._nextListener=this._head=i,this._finished&&this._notify(this._fired),i.returnPromise},cancel:function(){if(!this._finished){var t=this._canceller&&this._canceller(this);this._finished||(t instanceof Error||(t=Error(t)),t.log=!1,this.reject(t))}},_fired:-1,_complete:function(t,e){if(this._fired=e,this._finished)throw Error("This promise has already been resolved");this._result=t,this._finished=!0,this._notify(e)},_notify:function(t){for(var n,r,o;this._nextListener;)if(r=this._nextListener,this._nextListener=this._nextListener.next,n=r[t?"error":"resolved"])try{o=n(this._result),o&&i(o.then,"Function")?o.then(e.hitch(r.promise,"resolve"),e.hitch(r.promise,"reject")):r.promise.resolve(o)}catch(a){r.promise.reject(a)}else r.promise[t?"reject":"resolve"](result)}});return n.when=function(t,e,n,r){return t&&i(t.then,"function")?t.then(e,n,r):e?e(t):t},n});