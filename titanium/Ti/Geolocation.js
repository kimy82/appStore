define(["Ti/_/Evented","Ti/_/lang","Ti/Network"],function(e,t){function n(e){var t=d(window,"deviceorientation",function(n){t(),e(n)})}function i(e){return function(t){s={heading:{accuracy:t.webkitCompassAccuracy,magneticHeading:t.webkitCompassHeading},success:!0,timestamp:Date.now()},a.fireEvent("heading",s),e&&e(s)}}function r(e){return function(t){var n="coords"in t;c={success:n},n?c.coords=t.coords:c.code=t.code,a.fireEvent("location",c),e&&e(c)}}function o(){return{enableHighAccuracy:a.accuracy===a.ACCURACY_HIGH,timeout:a.MobileWeb.locationTimeout,maximumAge:a.MobileWeb.maximumLocationAge}}var a,s,u,l,c,d=require.on,f=!1,h=0,p=0,g=t.isDef;return n(function(e){g(e.webkitCompassHeading)&&(f=!0)}),a=t.setObject("Ti.Geolocation",e,{getCurrentPosition:function(e){a.locationServicesEnabled&&navigator.geolocation.getCurrentPosition(r(e),r(e),o())},getCurrentHeading:function(e){f&&(s&&Date.now()-s.timestamp<a.maximumHeadingAge?e(s):n(i(e)))},forwardGeocoder:function(e,t){if(require.is(e,"String")){var n=Ti.Network.createHTTPClient({onload:function(){var e=this.responseText.split(",");t({success:!0,places:[{latitude:parseFloat(e[2]),longitude:parseFloat(e[3])}]})},onerror:function(){t({success:!1})},timeout:a.MobileWeb.forwardGeocoderTimeout});n.open("GET","http://api.appcelerator.net/p/v1/geo?d=f&q="+escape(e)),n.send()}},reverseGeocoder:function(e,t,n){if(g(e)&&g(t)){var i=Ti.Network.createHTTPClient({onload:function(){n(JSON.parse(this.responseText))},onerror:function(){n({success:!1})},timeout:a.MobileWeb.forwardGeocoderTimeout});i.open("GET","http://api.appcelerator.net/p/v1/geo?d=r&q="+e+","+t),i.send()}},addEventListener:function(t,n){switch(t){case"heading":f&&(h++,1===h&&(u=d(window,"deviceorientation",i())));break;case"location":a.locationServicesEnabled&&(p++,1===p&&(l=navigator.geolocation.watchPosition(r(),r(),o())))}e.addEventListener.call(this,t,n)},removeEventListener:function(t,n){switch(t){case"heading":f&&(h--,0===h&&u());break;case"location":a.locationServicesEnabled&&(p--,1>h&&navigator.geolocation.clearWatch(l))}e.removeEventListener.call(this,t,n)},constants:{ACCURACY_HIGH:1,ACCURACY_LOW:2,ERROR_DENIED:1,ERROR_LOCATION_UNKNOWN:2,ERROR_TIMEOUT:3,locationServicesEnabled:{get:function(){return!!navigator.geolocation}},MobileWeb:{locationTimeout:1/0,maximumLocationAge:0,maximumHeadingAge:1e3,forwardGeocoderTimeout:void 0,reverseGeocoderTimeout:void 0},hasCompass:function(){return f}},properties:{accuracy:2}})});