define(["Ti/_/declare","Ti/_/Evented","Ti/_/style","Ti/UI"],function(t,e,n,i){function r(){i._layoutInProgress?h.once(i,"postlayout",function(){requestAnimationFrame(o)}):requestAnimationFrame(o)}function o(){var t,e,n,i,o,a,s,l,h,f,p,_,g,T=d();u=0;for(t in I)for(e=I[t],o=0;e.length>o;o++)if(n=e[o],!n.paused){if(f=n.duration?Math.min(1,(T-n.ts)/n.duration):1,p=c[n.curve](n.forward?f:1-f),i=n.elem,i._isAttachedToActiveWin())for(prop in n.props){if(g=n.props[prop],l=g[0],h=g[1],1===f&&(_=n.forward?h:l),"transform"===prop){if(1!==f){for(_=[],s=l.length,a=0;s>a;a++)(12>a||a>14)&&(_[a]=l[a]+(h[a]-l[a])*p);u=1}16===_.length?(a=_.splice(12),_="matrix3d("+_.join(",")+") rotate3d("+a.join(",")+"deg)"):(a=_.pop(),_="matrix("+_.join(",")+") rotate("+a+"deg)"),prop=S}else if(m[prop]){if(1!==f){for(_=[],a=0;4>a;a++)_[a]=Math.floor(l[a]+(h[a]-l[a])*p);u=1}_="rgba("+_.join(",")+")"}else v[prop]&&(1!==f&&(_=l+(h-l)*p,u=1),_="opacity"===prop?_:_+"px");n.prev!==_&&(i.domNode.style[prop]=_),n.prev=_}1===f&&(n.ts=T,n.duration&&n.reverse&&n.forward?(n.forward=0,u=1):n.repeat-->0?u=n.forward=1:(e.splice(o--,1),n.promise.resolve(),e.length||delete I[t]))}u&&r()}function a(t){var e,n,i,r;if(t=t.trim().toLowerCase(),"#"===t.charAt(0))n=4==t.length?4:8,isNaN(t=Number("0x"+t.substring(1)))||(i=(1<<n)-1,r=4===n?17:1,r=[(t>>2*n&i)*r,(t>>n&i)*r,(t&i)*r,1]);else if(e=t.match(T))for(r=e[1].split(/\s*,\s*/),e=0;3>e;)r[e++]|=0;else N&&(r=N[t]);return r?(r[3]=isNaN(e=parseFloat(r[3]))?1:Math.min(Math.max(e,0),1),r):void 0}function s(t,e,n,i){var r,o,a,s,u=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];if(t)if(r=t[1],o=t[2].split(","),a=o.length,r&&16===a)for(s=0;12>s;s++)u[s]=o[s];else r||6!==a||(u[0]=o[0],u[1]=o[1],u[4]=o[2],u[5]=o[3],u[3]=o[4],u[7]=o[5]);if(e)if(r=e[1],o=e[2].split(","),a=o.length,r&&4===a)for(s=0;4>s;s++)u[12+s]=o[s];else r||1!==a||(u[14]=1,u[15]=o[0]);return n=2===i?[n.a,n.b,0,n.tx,n.c,n.d,0,n.ty,0,0,1,0,0,0,1,n.rotation]:[n.m11,n.m12,n.m13,n.m14,n.m21,n.m22,n.m23,n.m24,n.m31,n.m32,n.m33,n.m34,n.rotationX,n.rotationY,n.rotationZ,n.rotation],[u,n]}for(var u,c=[function(t){return t*=2,1>t?Math.pow(t,2)/2:-1*(--t*(t-2)-1)/2},function(t){return Math.pow(t,2)},function(t){return-1*t*(t-2)},function(t){return t}],l=window,d=Date.now,h=require.on,f=0,p=["ms","moz","webkit","o"],_=p.length,g={autoreverse:1,bottom:1,center:1,curve:1,delay:1,duration:1,repeat:1,right:1,visible:1,zIndex:1},m={backgroundColor:1,color:1},v={height:1,left:1,opacity:1,top:1,width:1},T=/^rgba?\(([\s\.,0-9]+)\)/,E=/3d/,y=/^Ti\.UI\.(2|3)DMatrix$/,A=/matrix(3d)?\(([^\)]*)/,b=/rotate(3d)?\(([^\)]*)/,I={},S=n.discover("transform"),N=require(require.config.ti.colorsModule),O=t("Ti.UI.Animation",e,{properties:{autoreverse:void 0,backgroundColor:void 0,bottom:void 0,center:void 0,color:void 0,curve:void 0,delay:void 0,duration:void 0,height:void 0,left:void 0,opacity:void 0,repeat:void 0,right:void 0,top:void 0,transform:void 0,visible:void 0,width:void 0,zIndex:void 0}});--_>=0&&!l.requestAnimationFrame;)l.requestAnimationFrame=l[p[_]+"RequestAnimationFrame"];return l.requestAnimationFrame||(l.requestAnimationFrame=function(t){var e=d(),n=Math.max(0,16-(e-f)),i=window.setTimeout(function(){t(e+n)},n);return f=e+n,i}),O._play=function(t,e){function i(){var i,o,T,S,N,O,w,L,x,C,D={},R=t._parent._layout.calculateAnimation(t,e);for(T in _)if(O=_[T],!g[T]&&void 0!==O){for(i=0;p.length>i;i++)delete p[i].props[T],require.isEmpty(p[i].props)&&p.splice(i--,1);if(S=n.get(t.domNode,T),m[T])S=a(S),O=a(O),(O>S||S>O)&&(D[T]=[S,O]);else if(v[T])isNaN(S=parseFloat(S))&&"opacity"===T&&(S=1),O=T in R?R[T]:O,S!==O&&(D[T]=[S,O]);else if("transform"===T&&(N=O.declaredClass.match(y))){if(N=0|N[1],x=S.match(A),C=S.match(b),E.test(S)||3===N)w=s(x,C,O,N),S=w[0],O=w[1];else if(2===N){if(S=[1,0,0,1,0,0,0],x)for(L=x[2].split(","),o=Math.min(6,L.length),i=0;o>i;i++)S[i]=parseFloat(L[i]);C&&(L=C[2].split(","),L.length&&(S[6]=parseFloat(L[0]))),O=[O.a,O.b,O.c,O.d,O.tx,O.ty,O.rotation],w=[S,O]}(O>S||S>O)&&(D[T]=w)}}I[h].push({id:f,elem:t,promise:l,props:D,ts:d(),reverse:!!_.autoreverse,forward:1,curve:Math.max(0,Math.min(c.length-1,0|_.curve)),duration:0|_.duration,repeat:!!_.repeat}),e.fireEvent("start"),u||(u=1,r())}function o(){for(var t=I[h],e=0,n=t&&t.length;n>e;e++)if(t[e].id===f)return t[e]}var l=new require.Promise,h=t.widgetId,f=0|1e9*Math.random(),p=I[h]=I[h]||[],_=e.properties.__values__,T=0|_.delay,S=!!_.visible;return T?setTimeout(i,T):i(),l.source=t,l.animation=e,l.pause=function(){var t=o();return t=!!t&&(t.paused||(t.paused=d())),e.fireEvent("pause"),t},l.resume=function(){var t=o();return t&&(t.paused&&(t.ts+=d()-t.paused),u||(u=1,r())),t=!!t&&!(t.paused=0),e.fireEvent("resume"),t},l.cancel=function(t){for(var i,r,o,a=I[h],s=0,u=a&&a.length,c=!1;u>s;s++)if(a[s].id===f){if(i=a[s],t){o=i.elem.domNode;for(r in i.props)u=i.props[r][0],n.set(o,r,v[r]&&"opacity"!==r?u+"px":u)}a.splice(s,1),a.length||delete I[h],c=!0;break}return e.fireEvent("cancel"),c},l.then(function(){void 0!==_.visible&&(t.visible=S),void 0!==_.zIndex&&(t.zIndex=zIndex),e.fireEvent("complete")})},O});